// Prisma schema file for Incubation Management System

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  director
  manager
  mentor
  incubator
}

enum PasswordStatus {
  needs_change
  ok
}

// User account lifecycle status
enum UserStatus {
  active
  inactive
}

enum TeamStatus {
  active
  pending
  inactive
}

enum ProjectStatus {
  active
  pending
  completed
  on_hold
}

enum ProjectCategory {
  Technology
  Agriculture
  Health
  Education
  Design
  SocialImpact
  Sustainability
  AgriTech
  HealthTech
  EdTech
  RoboticsAI
  FinTech
  OpenToAny
  Other
}

enum EnrollmentStatus {
  CurrentlyEnrolled
  Graduated
  OnLeave
  Other
}

enum ProjectStatusAtEnrollment {
  Idea
  Prototype
  MVP
  Beta
  Launched
}

enum CurrentRoleInProject {
  ProjectLead
  Employee
  FounderCoFounder
  AttendsWorkshopsOnly
  Other
}

enum ItemCategory {
  Equipment
  Tools
  Furniture
  Electronics
  Consumables
  Refreshments
  OfficeSupplies
  Software
  Vehicles
  Other
}

enum ItemType {
  Perishable
  NonPerishable
  Returnable
  Consumable
  Refreshment
  FixedAsset
}

enum ItemCondition {
  New
  Good
  Fair
  Poor
  Damaged
  Retired
}

enum InventoryStatus {
  available
  reserved
  assigned
  maintenance
  damaged
  retired
  disposed
  out_of_stock
  low_stock
}

enum RequestPriority {
  Low
  Medium
  High
  Urgent
}

enum RequestStatus {
  draft
  submitted
  pending_review
  approved
  partially_approved
  declined
  cancelled
  ordered
  in_transit
  delivered
  completed
  returned
}

enum DeliveryStatus {
  not_ordered
  ordered
  in_transit
  delivered
  delayed
  cancelled
}

enum MessageType {
  text
  file
}

enum RecipientType {
  team
  user
}

enum TeamMemberRole {
  team_leader
  member
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
}

// User model
model User {
  id              String         @id @default(cuid())
  email           String         @unique
  password_hash   String
  role            UserRole
  status          UserStatus     @default(active)
  password_status PasswordStatus @default(needs_change)
  name            String // Keep for backward compatibility

  // Phase 1: Essential Information
  first_name        String?
  middle_name       String?
  last_name         String?
  phone             String?
  profile_photo_url String?

  // Phase 2: Academic Profile
  enrollment_status EnrollmentStatus?
  major_program     String?
  program_of_study  String?
  graduation_year   Int?

  // Phase 3: Professional Profile
  current_role      CurrentRoleInProject?
  skills            Json? // Array of skills: ["Coding/Development", "UX/UI Design", ...]
  support_interests Json? // Array of interests: ["Mentorship", "Funding", ...]

  // Phase 5: Additional Information
  additional_notes String? @db.Text

  // Soft delete / deactivation tracking
  deactivated_at DateTime?

  // Profile completion tracking
  profile_completion_percentage Int   @default(0)
  profile_phase_completion      Json? // Track which phases are complete

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  team_members                   TeamMember[]
  projects_uploaded              ProjectFile[]
  mentors_created                Mentor[]
  requests_created               MaterialRequest[]      @relation("RequestedBy")
  requests_reviewed              MaterialRequest[]      @relation("ReviewedBy")
  requests_approved              MaterialRequest[]      @relation("ApprovedBy")
  request_comments               RequestComment[]
  request_attachments            RequestAttachment[]
  request_history                RequestHistory[]
  request_approvals              RequestApproval[]      @relation("RequestApprover")
  request_approvals_delegated    RequestApproval[]      @relation("RequestApprovalDelegate")
  request_templates_created      RequestTemplate[]
  messages_sent                  Message[]
  notifications_sent             Notification[]
  announcements_created          Announcement[]
  email_preferences              EmailPreferences?
  inventory_assignments_assigned InventoryAssignment[]
  inventory_transactions         InventoryTransaction[]
  consumption_logs_distributed   ConsumptionLog[]
  maintenance_logs_performed     MaintenanceLog[]
  InventoryReservation           InventoryReservation[]

  @@map("users")
}

// Team model
model Team {
  id                      String     @id @default(cuid())
  team_name               String
  company_name            String?
  status                  TeamStatus @default(pending)
  enrollment_date         DateTime? // Date the company/team enrolled in the hub
  rdb_registration_status String? // RDB registration status
  deactivated_at          DateTime? // Timestamp when team was deactivated (soft delete)
  created_at              DateTime   @default(now())
  updated_at              DateTime   @updatedAt

  // Relations
  team_members           TeamMember[]
  projects               Project[]
  mentor_assignments     MentorAssignment[]
  inventory_assignments  InventoryAssignment[]
  inventory_reservations InventoryReservation[]
  material_requests      MaterialRequest[]
  consumption_logs       ConsumptionLog[]

  @@map("teams")
}

// Team Member model
model TeamMember {
  id        String         @id @default(cuid())
  team_id   String
  user_id   String
  role      TeamMemberRole @default(member)
  joined_at DateTime       @default(now())

  // Relations
  team Team @relation(fields: [team_id], references: [id], onDelete: Cascade)
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([team_id, user_id])
  @@map("team_members")
}

// Project model
model Project {
  id          String  @id @default(cuid())
  name        String
  description String? @db.Text

  // Enhanced project information
  startup_company_name  String?
  status_at_enrollment  ProjectStatusAtEnrollment?
  challenge_description String?                    @db.Text

  team_id    String
  category   ProjectCategory
  status     ProjectStatus   @default(pending)
  progress   Int             @default(0)
  created_at DateTime        @default(now())
  updated_at DateTime        @updatedAt

  // Relations
  team            Team            @relation(fields: [team_id], references: [id], onDelete: Cascade)
  project_files   ProjectFile[]
  material_requests MaterialRequest[]

  @@map("projects")
}

// Project File model
model ProjectFile {
  id          String   @id @default(cuid())
  project_id  String
  file_name   String
  file_path   String
  file_type   String?
  file_size   Int?
  uploaded_by String
  uploaded_at DateTime @default(now())

  // Relations
  project  Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
  uploader User    @relation(fields: [uploaded_by], references: [id])

  @@map("project_files")
}

// Mentor model
model Mentor {
  id         String   @id @default(cuid())
  user_id    String   @unique
  expertise  String?
  phone      String?
  created_at DateTime @default(now())

  // Relations
  user               User               @relation(fields: [user_id], references: [id], onDelete: Cascade)
  mentor_assignments MentorAssignment[]

  @@map("mentors")
}

// Mentor Assignment model
model MentorAssignment {
  id          String   @id @default(cuid())
  mentor_id   String
  team_id     String
  assigned_at DateTime @default(now())

  // Relations
  mentor Mentor @relation(fields: [mentor_id], references: [id], onDelete: Cascade)
  team   Team   @relation(fields: [team_id], references: [id], onDelete: Cascade)

  @@unique([mentor_id, team_id])
  @@map("mentor_assignments")
}

// Inventory Item model
model InventoryItem {
  id          String       @id @default(cuid())
  name        String
  description String?      @db.Text
  category    ItemCategory @default(Other)
  item_type   ItemType     @default(Consumable)
  tags        Json? // Array of tags

  // Identification
  sku           String? @unique // Stock Keeping Unit
  barcode       String? @unique
  serial_number String? @unique

  // Quantities
  total_quantity     Int @default(0)
  available_quantity Int @default(0)
  reserved_quantity  Int @default(0)
  consumed_quantity  Int @default(0) // For consumables/refreshments

  // Replenishment (for consumables/refreshments)
  min_stock_level  Int? // Alert when below this
  reorder_quantity Int? // Quantity to reorder
  last_replenished DateTime?

  // Physical
  condition   ItemCondition   @default(Good)
  status      InventoryStatus @default(available)
  location_id String?

  // Warranty & Maintenance
  warranty_start       DateTime?
  warranty_end         DateTime?
  warranty_provider    String?
  maintenance_interval Int? // Days between maintenance
  last_maintenance     DateTime?
  next_maintenance     DateTime?

  // Supplier
  supplier_id   String?
  purchase_date DateTime?

  // Expiration (for consumables/refreshments)
  expiration_date DateTime?
  batch_number    String? // For tracking batches of consumables

  // Consumption tracking (for refreshments/consumables)
  is_frequently_distributed Boolean @default(false) // Coffee, water, juice, snacks, etc.
  distribution_unit         String? // cup, bottle, packet, kg, liter, etc.
  typical_consumption_rate  Int? // Average consumption per day/week (for planning)

  // Metadata
  custom_fields Json? // Flexible custom fields
  notes         String? @db.Text

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  location               StorageLocation?       @relation(fields: [location_id], references: [id])
  supplier               Supplier?              @relation(fields: [supplier_id], references: [id])
  inventory_assignments  InventoryAssignment[]
  inventory_reservations InventoryReservation[]
  inventory_transactions InventoryTransaction[]
  maintenance_logs       MaintenanceLog[]
  consumption_logs       ConsumptionLog[]
  request_items          RequestItem[]

  @@map("inventory_items")
}

// Storage Location model
model StorageLocation {
  id                 String   @id @default(cuid())
  name               String
  building           String?
  floor              String?
  room               String?
  shelf              String?
  bin                String?
  parent_location_id String?
  notes              String?  @db.Text
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  // Relations
  parent_location StorageLocation?  @relation("LocationHierarchy", fields: [parent_location_id], references: [id])
  child_locations StorageLocation[] @relation("LocationHierarchy")
  items           InventoryItem[]

  @@map("storage_locations")
}

// Supplier model
model Supplier {
  id             String   @id @default(cuid())
  name           String
  contact_person String?
  email          String?
  phone          String?
  address        String?  @db.Text
  notes          String?  @db.Text
  rating         Decimal? @db.Decimal(3, 2) // Quality/service rating (1-5)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  // Relations
  items InventoryItem[]

  @@map("suppliers")
}

// Inventory Assignment model
model InventoryAssignment {
  id               String         @id @default(cuid())
  item_id          String
  team_id          String
  quantity         Int
  assigned_by      String
  assigned_at      DateTime       @default(now())
  expected_return  DateTime?
  returned_at      DateTime?
  return_condition ItemCondition?
  return_notes     String?        @db.Text
  status           String         @default("active") // active, returned, lost, damaged

  // Relations
  item     InventoryItem @relation(fields: [item_id], references: [id], onDelete: Cascade)
  team     Team          @relation(fields: [team_id], references: [id], onDelete: Cascade)
  assigner User          @relation(fields: [assigned_by], references: [id])

  @@map("inventory_assignments")
}

// Inventory Reservation model
model InventoryReservation {
  id             String   @id @default(cuid())
  item_id        String
  team_id        String
  quantity       Int
  reserved_by    String
  reserved_at    DateTime @default(now())
  reserved_until DateTime
  status         String   @default("pending") // pending, confirmed, cancelled, expired
  notes          String?  @db.Text

  // Relations
  item     InventoryItem @relation(fields: [item_id], references: [id], onDelete: Cascade)
  team     Team          @relation(fields: [team_id], references: [id], onDelete: Cascade)
  reserver User          @relation(fields: [reserved_by], references: [id])

  @@map("inventory_reservations")
}

// Inventory Transaction model (for audit trail)
model InventoryTransaction {
  id                String   @id @default(cuid())
  item_id           String
  transaction_type  String // assign, return, add, remove, adjust, damage, consume
  quantity          Int
  previous_quantity Int
  new_quantity      Int
  performed_by      String
  notes             String?  @db.Text
  created_at        DateTime @default(now())

  // Relations
  item      InventoryItem @relation(fields: [item_id], references: [id], onDelete: Cascade)
  performer User          @relation(fields: [performed_by], references: [id])

  @@map("inventory_transactions")
}

// Maintenance Log model
model MaintenanceLog {
  id               String    @id @default(cuid())
  item_id          String
  maintenance_type String // scheduled, repair, inspection, cleaning
  performed_by     String?
  performed_at     DateTime
  notes            String?   @db.Text
  next_maintenance DateTime?

  // Relations
  item       InventoryItem @relation(fields: [item_id], references: [id], onDelete: Cascade)
  technician User?         @relation(fields: [performed_by], references: [id])

  @@map("maintenance_logs")
}

// Consumption Log model (for refreshments/consumables tracking)
model ConsumptionLog {
  id               String   @id @default(cuid())
  item_id          String
  team_id          String?
  quantity         Int
  unit             String? // cup, bottle, packet, etc.
  distributed_by   String
  distributed_to   String? // Individual name or "Team Meeting", "Event", etc.
  consumption_date DateTime @default(now())
  consumption_type String? // daily_distribution, event, meeting, etc.
  notes            String?  @db.Text // Special notes (e.g., "for team meeting", "workshop refreshments")

  // Relations
  item        InventoryItem @relation(fields: [item_id], references: [id], onDelete: Cascade)
  team        Team?         @relation(fields: [team_id], references: [id], onDelete: Cascade)
  distributor User          @relation(fields: [distributed_by], references: [id])

  @@map("consumption_logs")
}

// Material Request model
model MaterialRequest {
  id                   String          @id @default(cuid())
  request_number       String          @unique // Auto-generated: REQ-YYYY-XXXX
  team_id              String
  project_id           String?         // Link to project if applicable

  // Request Details
  title                String
  description          String?         @db.Text
  priority             RequestPriority @default(Medium)
  urgency_reason       String?

  // Status & Workflow
  status               RequestStatus   @default(draft)
  current_approver     String?
  approval_chain       Json?           // Array of approver IDs

  // Request Type
  is_consumable_request Boolean        @default(false) // For refreshments/consumables
  requires_quick_approval Boolean      @default(false) // Fast-track for common items

  // Dates
  requested_at         DateTime        @default(now())
  required_by          DateTime?       // Deadline
  reviewed_at          DateTime?
  approved_at          DateTime?
  ordered_at           DateTime?
  delivered_at         DateTime?
  completed_at         DateTime?

  // People
  requested_by         String
  reviewed_by          String?
  approved_by          String?

  // Delivery
  delivery_status      DeliveryStatus  @default(not_ordered)
  delivery_address     String?
  delivery_notes       String?
  expected_delivery    DateTime?

  // Metadata
  notes                String?         @db.Text
  internal_notes       String?         @db.Text // For managers only

  // Relations
  team                 Team            @relation(fields: [team_id], references: [id], onDelete: Cascade)
  project              Project?        @relation(fields: [project_id], references: [id])
  requester            User            @relation("RequestedBy", fields: [requested_by], references: [id])
  reviewer             User?           @relation("ReviewedBy", fields: [reviewed_by], references: [id])
  approver             User?           @relation("ApprovedBy", fields: [approved_by], references: [id])
  items                RequestItem[]
  comments             RequestComment[]
  attachments          RequestAttachment[]
  history              RequestHistory[]
  approvals            RequestApproval[]

  @@map("material_requests")
}

model RequestItem {
  id                   String          @id @default(cuid())
  request_id           String
  inventory_item_id    String?         // Link to inventory if exists
  item_name            String          // Name if not in inventory
  description          String?
  quantity             Int
  unit                 String?         // cup, bottle, packet, piece, etc.
  notes                String?

  // Status
  status               String          @default("pending") // pending, approved, declined, distributed, delivered
  approved_quantity    Int?            // If partially approved
  distributed_quantity Int?            // Actually distributed (for consumables)

  // For consumables/refreshments
  is_consumable        Boolean         @default(false)
  distribution_date    DateTime?       // When it was distributed

  // Relations
  request              MaterialRequest @relation(fields: [request_id], references: [id], onDelete: Cascade)
  inventory_item       InventoryItem?  @relation(fields: [inventory_item_id], references: [id])

  @@map("request_items")
}

model RequestComment {
  id                   String          @id @default(cuid())
  request_id           String
  user_id              String
  comment              String          @db.Text
  is_internal          Boolean         @default(false) // Only visible to managers
  created_at           DateTime        @default(now())

  // Relations
  request              MaterialRequest @relation(fields: [request_id], references: [id], onDelete: Cascade)
  user                 User            @relation(fields: [user_id], references: [id])

  @@map("request_comments")
}

model RequestAttachment {
  id                   String          @id @default(cuid())
  request_id           String
  file_name            String
  file_path            String
  file_type            String?
  file_size            Int?
  uploaded_by          String
  uploaded_at          DateTime        @default(now())

  // Relations
  request              MaterialRequest @relation(fields: [request_id], references: [id], onDelete: Cascade)
  uploader             User            @relation(fields: [uploaded_by], references: [id])

  @@map("request_attachments")
}

model RequestHistory {
  id                   String          @id @default(cuid())
  request_id           String
  action               String          // created, updated, status_changed, commented, etc.
  old_value            Json?
  new_value            Json?
  performed_by         String
  performed_at         DateTime        @default(now())
  notes                String?

  // Relations
  request              MaterialRequest @relation(fields: [request_id], references: [id], onDelete: Cascade)
  performer            User            @relation(fields: [performed_by], references: [id])

  @@map("request_history")
}

model RequestApproval {
  id                   String          @id @default(cuid())
  request_id           String
  approver_id          String
  approval_level       Int             // 1, 2, 3, etc.
  status               String          @default("pending") // pending, approved, declined, delegated
  delegated_to         String?
  comments             String?
  approved_at          DateTime?

  // Relations
  request              MaterialRequest @relation(fields: [request_id], references: [id], onDelete: Cascade)
  approver             User            @relation("RequestApprover", fields: [approver_id], references: [id])
  delegate             User?           @relation("RequestApprovalDelegate", fields: [delegated_to], references: [id])

  @@map("request_approvals")
}

model RequestTemplate {
  id                   String          @id @default(cuid())
  name                 String
  description          String?
  category             String?
  items                Json            // Array of template items
  created_by           String
  is_public            Boolean         @default(false)
  created_at           DateTime        @default(now())

  // Relations
  creator              User            @relation(fields: [created_by], references: [id])

  @@map("request_templates")
}

// Message model
model Message {
  id              String      @id @default(cuid())
  conversation_id String
  sender_id       String
  content         String
  message_type    MessageType @default(text)
  file_path       String?
  sent_at         DateTime    @default(now())

  // Relations
  conversation Conversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [sender_id], references: [id], onDelete: Cascade)

  @@map("messages")
}

// Conversation model
model Conversation {
  id           String   @id @default(cuid())
  participants Json
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  // Relations
  messages Message[]

  @@map("conversations")
}

// Notification model
model Notification {
  id             String        @id @default(cuid())
  title          String
  message        String
  sender_id      String
  recipient_type RecipientType
  recipient_id   String
  read_status    Boolean       @default(false)
  created_at     DateTime      @default(now())

  // Relations
  sender User @relation(fields: [sender_id], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// Announcement model
model Announcement {
  id         String   @id @default(cuid())
  title      String
  content    String
  author_id  String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  author User @relation(fields: [author_id], references: [id], onDelete: Cascade)

  @@map("announcements")
}

// Email Log model
model EmailLog {
  id            String      @id @default(cuid())
  recipient     String
  subject       String
  template_name String
  status        EmailStatus
  error_message String?
  sent_at       DateTime?
  created_at    DateTime    @default(now())

  @@map("email_logs")
}

// Email Preferences model
model EmailPreferences {
  id                String   @id @default(cuid())
  user_id           String   @unique
  user_created      Boolean  @default(true)
  user_updated      Boolean  @default(true)
  team_updates      Boolean  @default(true)
  project_updates   Boolean  @default(true)
  notifications     Boolean  @default(false)
  messages          Boolean  @default(false)
  announcements     Boolean  @default(true)
  material_requests Boolean  @default(true)
  inventory_updates Boolean  @default(true)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("email_preferences")
}
