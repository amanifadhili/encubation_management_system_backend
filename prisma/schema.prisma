// Prisma schema file for Incubation Management System

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  director
  manager
  mentor
  incubator
}

enum PasswordStatus {
  needs_change
  ok
}

enum TeamStatus {
  active
  pending
  inactive
}

enum ProjectStatus {
  active
  pending
  completed
  on_hold
}

enum ProjectCategory {
  Technology
  Agriculture
  Health
  Education
  Design
  SocialImpact
  Sustainability
  AgriTech
  HealthTech
  EdTech
  RoboticsAI
  FinTech
  OpenToAny
  Other
}

enum EnrollmentStatus {
  CurrentlyEnrolled
  Graduated
  OnLeave
  Other
}

enum ProjectStatusAtEnrollment {
  Idea
  Prototype
  MVP
  Beta
  Launched
}

enum CurrentRoleInProject {
  ProjectLead
  Employee
  FounderCoFounder
  AttendsWorkshopsOnly
  Other
}

enum InventoryStatus {
  available
  low_stock
  out_of_stock
}

enum RequestStatus {
  pending
  approved
  declined
}

enum MessageType {
  text
  file
}

enum RecipientType {
  team
  user
}

enum TeamMemberRole {
  team_leader
  member
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
}

// User model
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password_hash String
  role          UserRole
  password_status PasswordStatus @default(needs_change)
  name          String // Keep for backward compatibility

  // Phase 1: Essential Information
  first_name        String?
  middle_name       String?
  last_name         String?
  phone             String?
  profile_photo_url String?

  // Phase 2: Academic Profile
  enrollment_status EnrollmentStatus?
  major_program     String?
  program_of_study  String?
  graduation_year   Int?

  // Phase 3: Professional Profile
  current_role      CurrentRoleInProject?
  skills            Json? // Array of skills: ["Coding/Development", "UX/UI Design", ...]
  support_interests Json? // Array of interests: ["Mentorship", "Funding", ...]

  // Phase 5: Additional Information
  additional_notes String? @db.Text

  // Profile completion tracking
  profile_completion_percentage Int   @default(0)
  profile_phase_completion      Json? // Track which phases are complete

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  team_members          TeamMember[]
  projects_uploaded     ProjectFile[]
  mentors_created       Mentor[]
  requests_created      MaterialRequest[] @relation("RequestedBy")
  requests_reviewed     MaterialRequest[] @relation("ReviewedBy")
  messages_sent         Message[]
  notifications_sent    Notification[]
  announcements_created Announcement[]
  email_preferences     EmailPreferences?

  @@map("users")
}

// Team model
model Team {
  id                   String     @id @default(cuid())
  team_name            String
  company_name         String?
  status               TeamStatus @default(pending)
  enrollment_date      DateTime?  // Date the company/team enrolled in the hub
  rdb_registration_status String? // RDB registration status
  created_at           DateTime   @default(now())
  updated_at           DateTime   @updatedAt

  // Relations
  team_members          TeamMember[]
  projects              Project[]
  mentor_assignments    MentorAssignment[]
  inventory_assignments InventoryAssignment[]
  material_requests     MaterialRequest[]

  @@map("teams")
}

// Team Member model
model TeamMember {
  id        String         @id @default(cuid())
  team_id   String
  user_id   String
  role      TeamMemberRole @default(member)
  joined_at DateTime       @default(now())

  // Relations
  team Team @relation(fields: [team_id], references: [id], onDelete: Cascade)
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([team_id, user_id])
  @@map("team_members")
}

// Project model
model Project {
  id          String  @id @default(cuid())
  name        String
  description String? @db.Text

  // Enhanced project information
  startup_company_name  String?
  status_at_enrollment  ProjectStatusAtEnrollment?
  challenge_description String?                    @db.Text

  team_id    String
  category   ProjectCategory
  status     ProjectStatus   @default(pending)
  progress   Int             @default(0)
  created_at DateTime        @default(now())
  updated_at DateTime        @updatedAt

  // Relations
  team          Team          @relation(fields: [team_id], references: [id], onDelete: Cascade)
  project_files ProjectFile[]

  @@map("projects")
}

// Project File model
model ProjectFile {
  id          String   @id @default(cuid())
  project_id  String
  file_name   String
  file_path   String
  file_type   String?
  file_size   Int?
  uploaded_by String
  uploaded_at DateTime @default(now())

  // Relations
  project  Project @relation(fields: [project_id], references: [id], onDelete: Cascade)
  uploader User    @relation(fields: [uploaded_by], references: [id])

  @@map("project_files")
}

// Mentor model
model Mentor {
  id         String   @id @default(cuid())
  user_id    String   @unique
  expertise  String?
  phone      String?
  created_at DateTime @default(now())

  // Relations
  user               User               @relation(fields: [user_id], references: [id], onDelete: Cascade)
  mentor_assignments MentorAssignment[]

  @@map("mentors")
}

// Mentor Assignment model
model MentorAssignment {
  id          String   @id @default(cuid())
  mentor_id   String
  team_id     String
  assigned_at DateTime @default(now())

  // Relations
  mentor Mentor @relation(fields: [mentor_id], references: [id], onDelete: Cascade)
  team   Team   @relation(fields: [team_id], references: [id], onDelete: Cascade)

  @@unique([mentor_id, team_id])
  @@map("mentor_assignments")
}

// Inventory Item model
model InventoryItem {
  id                 String          @id @default(cuid())
  name               String
  description        String?
  total_quantity     Int             @default(0)
  available_quantity Int             @default(0)
  status             InventoryStatus @default(available)
  created_at         DateTime        @default(now())
  updated_at         DateTime        @updatedAt

  // Relations
  inventory_assignments InventoryAssignment[]

  @@map("inventory_items")
}

// Inventory Assignment model
model InventoryAssignment {
  id          String    @id @default(cuid())
  item_id     String
  team_id     String
  quantity    Int
  assigned_at DateTime  @default(now())
  returned_at DateTime?

  // Relations
  item InventoryItem @relation(fields: [item_id], references: [id], onDelete: Cascade)
  team Team          @relation(fields: [team_id], references: [id], onDelete: Cascade)

  @@map("inventory_assignments")
}

// Material Request model
model MaterialRequest {
  id           String        @id @default(cuid())
  team_id      String
  item_name    String
  description  String?
  status       RequestStatus @default(pending)
  requested_by String
  reviewed_by  String?
  requested_at DateTime      @default(now())
  reviewed_at  DateTime?

  // Relations
  team      Team  @relation(fields: [team_id], references: [id], onDelete: Cascade)
  requester User  @relation("RequestedBy", fields: [requested_by], references: [id])
  reviewer  User? @relation("ReviewedBy", fields: [reviewed_by], references: [id])

  @@map("material_requests")
}

// Message model
model Message {
  id              String      @id @default(cuid())
  conversation_id String
  sender_id       String
  content         String
  message_type    MessageType @default(text)
  file_path       String?
  sent_at         DateTime    @default(now())

  // Relations
  conversation Conversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [sender_id], references: [id], onDelete: Cascade)

  @@map("messages")
}

// Conversation model
model Conversation {
  id           String   @id @default(cuid())
  participants Json
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  // Relations
  messages Message[]

  @@map("conversations")
}

// Notification model
model Notification {
  id             String        @id @default(cuid())
  title          String
  message        String
  sender_id      String
  recipient_type RecipientType
  recipient_id   String
  read_status    Boolean       @default(false)
  created_at     DateTime      @default(now())

  // Relations
  sender User @relation(fields: [sender_id], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// Announcement model
model Announcement {
  id         String   @id @default(cuid())
  title      String
  content    String
  author_id  String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  author User @relation(fields: [author_id], references: [id], onDelete: Cascade)

  @@map("announcements")
}

// Email Log model
model EmailLog {
  id            String      @id @default(cuid())
  recipient     String
  subject       String
  template_name String
  status        EmailStatus
  error_message String?
  sent_at       DateTime?
  created_at    DateTime    @default(now())

  @@map("email_logs")
}

// Email Preferences model
model EmailPreferences {
  id                String   @id @default(cuid())
  user_id           String   @unique
  user_created      Boolean  @default(true)
  user_updated      Boolean  @default(true)
  team_updates      Boolean  @default(true)
  project_updates   Boolean  @default(true)
  notifications     Boolean  @default(false)
  messages          Boolean  @default(false)
  announcements     Boolean  @default(true)
  material_requests Boolean  @default(true)
  inventory_updates Boolean  @default(true)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("email_preferences")
}
